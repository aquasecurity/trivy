# SBOM scan test
# This test verifies that Trivy can generate SBOM and scan it consistently

# 1. Scan image and generate table report
trivy image --cache-dir $WORK/.cache --format table --output normal_scan.txt --db-repository mirror.gcr.io/aquasec/trivy-db@${TRIVY_DB_DIGEST} alpine:3.19@sha256:c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b

# 2. Generate SBOM in CycloneDX format  
trivy image --cache-dir $WORK/.cache --format cyclonedx --output sbom.json --db-repository mirror.gcr.io/aquasec/trivy-db@${TRIVY_DB_DIGEST} alpine:3.19@sha256:c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b

# 3. Scan the generated SBOM
trivy sbom --cache-dir $WORK/.cache --format table --output sbom_scan.txt --db-repository mirror.gcr.io/aquasec/trivy-db@${TRIVY_DB_DIGEST} sbom.json

# 4. Verify all files were created
exists normal_scan.txt
exists sbom_scan.txt
exists sbom.json

# 5. Compare results - both should have similar vulnerability findings
cmp normal_scan.txt sbom_scan_golden.txt
cmp sbom_scan.txt sbom_scan_golden.txt

# Verify scan completed successfully
! stderr 'FATAL'

# Verify cache directory was created
exists $WORK/.cache

-- sbom_scan_golden.txt --

Report Summary

┌───────────────────────────┬────────┬─────────────────┐
│          Target           │  Type  │ Vulnerabilities │
├───────────────────────────┼────────┼─────────────────┤
│ sbom.json (alpine 3.19.1) │ alpine │       28        │
└───────────────────────────┴────────┴─────────────────┘
Legend:
- '-': Not scanned
- '0': Clean (no security findings detected)


For OSS Maintainers: VEX Notice
--------------------------------
If you're an OSS maintainer and Trivy has detected vulnerabilities in your project that you believe are not actually exploitable, consider issuing a VEX (Vulnerability Exploitability eXchange) statement.
VEX allows you to communicate the actual status of vulnerabilities in your project, improving security transparency and reducing false positives for your users.
Learn more and start using VEX: https://trivy.dev/dev/docs/supply-chain/vex/repo#publishing-vex-documents

To disable this notice, set the TRIVY_DISABLE_VEX_NOTICE environment variable.


sbom.json (alpine 3.19.1)
=========================
Total: 28 (UNKNOWN: 2, LOW: 4, MEDIUM: 20, HIGH: 2, CRITICAL: 0)

┌───────────────┬────────────────┬──────────┬────────┬──────────────────────┬──────────────────────┬─────────────────────────────────────────────────────────────┐
│    Library    │ Vulnerability  │ Severity │ Status │  Installed Version   │    Fixed Version     │                            Title                            │
├───────────────┼────────────────┼──────────┼────────┼──────────────────────┼──────────────────────┼─────────────────────────────────────────────────────────────┤
│ busybox       │ CVE-2023-42363 │ MEDIUM   │ fixed  │ 1.36.1-r15           │ 1.36.1-r17           │ busybox: use-after-free in awk                              │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42363                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42364 │          │        │                      │ 1.36.1-r19           │ busybox: use-after-free                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42364                  │
│               ├────────────────┤          │        │                      │                      ├─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42365 │          │        │                      │                      │ busybox: use-after-free                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42365                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42366 │          │        │                      │ 1.36.1-r16           │ busybox: A heap-buffer-overflow                             │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42366                  │
├───────────────┼────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│ busybox-binsh │ CVE-2023-42363 │          │        │                      │ 1.36.1-r17           │ busybox: use-after-free in awk                              │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42363                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42364 │          │        │                      │ 1.36.1-r19           │ busybox: use-after-free                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42364                  │
│               ├────────────────┤          │        │                      │                      ├─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42365 │          │        │                      │                      │ busybox: use-after-free                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42365                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42366 │          │        │                      │ 1.36.1-r16           │ busybox: A heap-buffer-overflow                             │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42366                  │
├───────────────┼────────────────┼──────────┤        ├──────────────────────┼──────────────────────┼─────────────────────────────────────────────────────────────┤
│ libcrypto3    │ CVE-2024-6119  │ HIGH     │        │ 3.1.4-r5             │ 3.1.7-r0             │ openssl: Possible denial of service in X.509 name checks    │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-6119                   │
│               ├────────────────┼──────────┤        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-13176 │ MEDIUM   │        │                      │ 3.1.8-r0             │ openssl: Timing side-channel in ECDSA signature computation │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-13176                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-4603  │          │        │                      │ 3.1.5-r0             │ openssl: Excessive time spent checking DSA keys and         │
│               │                │          │        │                      │                      │ parameters                                                  │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-4603                   │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-4741  │          │        │                      │ 3.1.6-r0             │ openssl: Use After Free with SSL_free_buffers               │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-4741                   │
│               ├────────────────┤          │        │                      │                      ├─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-5535  │          │        │                      │                      │ openssl: SSL_select_next_proto buffer overread              │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-5535                   │
│               ├────────────────┼──────────┤        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-2511  │ LOW      │        │                      │ 3.1.4-r6             │ openssl: Unbounded memory growth with session handling in   │
│               │                │          │        │                      │                      │ TLSv1.3                                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-2511                   │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-9143  │          │        │                      │ 3.1.7-r1             │ openssl: Low-level invalid GF(2^m) parameters lead to OOB   │
│               │                │          │        │                      │                      │ memory access                                               │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-9143                   │
├───────────────┼────────────────┼──────────┤        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│ libssl3       │ CVE-2024-6119  │ HIGH     │        │                      │ 3.1.7-r0             │ openssl: Possible denial of service in X.509 name checks    │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-6119                   │
│               ├────────────────┼──────────┤        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-13176 │ MEDIUM   │        │                      │ 3.1.8-r0             │ openssl: Timing side-channel in ECDSA signature computation │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-13176                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-4603  │          │        │                      │ 3.1.5-r0             │ openssl: Excessive time spent checking DSA keys and         │
│               │                │          │        │                      │                      │ parameters                                                  │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-4603                   │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-4741  │          │        │                      │ 3.1.6-r0             │ openssl: Use After Free with SSL_free_buffers               │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-4741                   │
│               ├────────────────┤          │        │                      │                      ├─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-5535  │          │        │                      │                      │ openssl: SSL_select_next_proto buffer overread              │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-5535                   │
│               ├────────────────┼──────────┤        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-2511  │ LOW      │        │                      │ 3.1.4-r6             │ openssl: Unbounded memory growth with session handling in   │
│               │                │          │        │                      │                      │ TLSv1.3                                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-2511                   │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2024-9143  │          │        │                      │ 3.1.7-r1             │ openssl: Low-level invalid GF(2^m) parameters lead to OOB   │
│               │                │          │        │                      │                      │ memory access                                               │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2024-9143                   │
├───────────────┼────────────────┼──────────┤        ├──────────────────────┼──────────────────────┼─────────────────────────────────────────────────────────────┤
│ musl          │ CVE-2025-26519 │ UNKNOWN  │        │ 1.2.4_git20230717-r4 │ 1.2.4_git20230717-r5 │ musl libc 0.9.13 through 1.2.5 before 1.2.6 has an          │
│               │                │          │        │                      │                      │ out-of-bounds write ......                                  │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2025-26519                  │
├───────────────┤                │          │        │                      │                      │                                                             │
│ musl-utils    │                │          │        │                      │                      │                                                             │
│               │                │          │        │                      │                      │                                                             │
│               │                │          │        │                      │                      │                                                             │
├───────────────┼────────────────┼──────────┤        ├──────────────────────┼──────────────────────┼─────────────────────────────────────────────────────────────┤
│ ssl_client    │ CVE-2023-42363 │ MEDIUM   │        │ 1.36.1-r15           │ 1.36.1-r17           │ busybox: use-after-free in awk                              │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42363                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42364 │          │        │                      │ 1.36.1-r19           │ busybox: use-after-free                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42364                  │
│               ├────────────────┤          │        │                      │                      ├─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42365 │          │        │                      │                      │ busybox: use-after-free                                     │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42365                  │
│               ├────────────────┤          │        │                      ├──────────────────────┼─────────────────────────────────────────────────────────────┤
│               │ CVE-2023-42366 │          │        │                      │ 1.36.1-r16           │ busybox: A heap-buffer-overflow                             │
│               │                │          │        │                      │                      │ https://avd.aquasec.com/nvd/cve-2023-42366                  │
└───────────────┴────────────────┴──────────┴────────┴──────────────────────┴──────────────────────┴─────────────────────────────────────────────────────────────┘
