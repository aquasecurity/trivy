# SBOM scan test
# This test verifies that Trivy can generate SBOM and scan it consistently

[condition:internet]

# 1. Scan image and generate JSON report
exec trivy image --format json --output result1.json alpine:3.19@sha256:c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b

# 2. Generate SBOM in CycloneDX format  
exec trivy image --format cyclonedx --output sbom.json alpine:3.19@sha256:c5b1261d6d3e43071626931fc004f70149baeba2c8ec672bd4f27761f8e1ad6b

# 3. Scan the generated SBOM
exec trivy sbom --format json --output result2.json sbom.json

# 4. Verify all files were created
exists result1.json
exists result2.json  
exists sbom.json

# 5. Compare results (simplified comparison)
compare-json result1.json result2.json

# Verify scan completed successfully
! stderr 'FATAL'

# Verify cache directory was created
exists $WORK/.cache
exists $WORK/.tmp